name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "echo 'SSH connection successful'"

      - name: Create Deploy Directory
        run: |
          echo "Creating deployment directory..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "mkdir -p ~/deploy-temp"
          echo "Directory created successfully"

      - name: Copy Files to VM
        run: |
          echo "Starting file transfer..."
          scp -i ~/.ssh/deploy_key -r ./* ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:~/deploy-temp/
          echo "Files transferred successfully"

      - name: Deploy Application
        env:
          APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          echo "Starting deployment process..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "Setting up deployment directory..."
            DEPLOY_DIR="$HOME/app"
            mkdir -p "$DEPLOY_DIR"
            
            echo "Stopping PM2 process..."
            pm2 stop ${{ secrets.APP_NAME }} 2>/dev/null || echo "No existing process to stop"
            pm2 delete ${{ secrets.APP_NAME }} 2>/dev/null || echo "No existing process to delete"
            
            echo "Backing up old deployment..."
            if [ -d "$DEPLOY_DIR/current" ]; then
              rm -rf "$DEPLOY_DIR/backup"
              mv "$DEPLOY_DIR/current" "$DEPLOY_DIR/backup"
            fi
            
            echo "Moving new deployment..."
            mkdir -p "$DEPLOY_DIR/current"
            mv ~/deploy-temp/* "$DEPLOY_DIR/current/" 2>/dev/null || true
            mv ~/deploy-temp/.* "$DEPLOY_DIR/current/" 2>/dev/null || true
            rm -rf ~/deploy-temp
            cd "$DEPLOY_DIR/current"
            
            echo "Installing dependencies..."
            npm install --production
            
            echo "Starting application with PM2..."
            pm2 start npm --name "${{ secrets.APP_NAME }}" -- start
            pm2 save
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key