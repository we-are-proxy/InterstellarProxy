name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  Deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "echo 'SSH connection successful'"

      - name: Deploy Application
        env:
          APP_NAME: ${{ secrets.APP_NAME }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "Starting deployment process..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "Setting up deployment directory..."
            DEPLOY_DIR="/home/${{ secrets.VM_USER }}/app"
            TEMP_DIR="/home/${{ secrets.VM_USER }}/deploy-temp"
            
            mkdir -p "$DEPLOY_DIR"
            
            echo "Stopping PM2 process..."
            pm2 stop ${{ secrets.APP_NAME }} 2>/dev/null || echo "No existing process to stop"
            pm2 delete ${{ secrets.APP_NAME }} 2>/dev/null || echo "No existing process to delete"
            
            echo "Cloning repository..."
            rm -rf "$TEMP_DIR"
            git clone ${{ env.REPO_URL }} "$TEMP_DIR"
            cd "$TEMP_DIR"
            git checkout ${{ env.COMMIT_SHA }}
            
            echo "Backing up old deployment..."
            if [ -d "$DEPLOY_DIR/current" ]; then
              rm -rf "$DEPLOY_DIR/backup"
              mv "$DEPLOY_DIR/current" "$DEPLOY_DIR/backup"
            fi
            
            echo "Moving new deployment..."
            mv "$TEMP_DIR" "$DEPLOY_DIR/current"
            cd "$DEPLOY_DIR/current"
            
            echo "Installing dependencies..."
            export npm_config_cache="/home/${{ secrets.VM_USER }}/.npm"
            mkdir -p "$npm_config_cache"
            npm install --omit=dev

            echo "Checking if echosystem.config.cjs exists..."
            if [ ! -f "ecosystem.config.cjs" ]; then
              echo "Error: ecosystem.config.cjs not found!"
              ls
              exit 1
            fi
            
            echo "Starting application with PM2..."
            pm2 start ecosystem.config.cjs
            pm2 save
            
            echo "✅ Deployment completed successfully!"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

  Configure_Nginx:
    runs-on: ubuntu-latest
    needs: Deploy

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Configure Nginx
        run: |
          echo "Configuring Nginx..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "Creating Nginx configuration..."
            NGINX_CONF="/etc/nginx/sites-available/proxy.maariz.org"
            sudo bash -c "cat > $NGINX_CONF" << EOL
            server {
              listen 80;
              listen [::]:80;

              server_name proxy.maariz.org www.proxy.maariz.org;

              index index.html index.htm;

              # Logs
              access_log /var/log/nginx/proxy.maariz.org.access.log;
              error_log /var/log/nginx/proxy.maariz.org.error.log;

              location / {
                proxy_pass http://localhost:8080;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host \$host;
                proxy_cache_bypass \$http_upgrade;
              }
            }
            EOL
            EOF
      - name: Enable Nginx
        run: |
          echo "Enabling Nginx configuration..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "Creating symlink for Nginx site..."
            sudo ln -sf /etc/nginx/sites-available/proxy.maariz.org /etc/nginx/sites-enabled/
            
            echo "Testing Nginx configuration..."
            sudo nginx -t
            
            echo "Reloading Nginx..."
            sudo systemctl reload nginx
            
            echo "✅ Nginx configured successfully!"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key