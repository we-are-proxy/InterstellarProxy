name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  Deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "echo 'SSH connection successful'"

      - name: Cache Node.js modules
        uses: actions/cache@v3
        with:
          path: node_modules # Or node_modules if you prefer to cache the installed directory
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Deploy Application
        env:
          APP_NAME: ${{ secrets.APP_NAME }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "Starting deployment process..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          set -e; echo "Setting up deployment directory..."
          DEPLOY_DIR="/home/${{ secrets.VM_USER }}/app"
          TEMP_DIR="/home/${{ secrets.VM_USER }}/deploy-temp"
          mkdir -p "$DEPLOY_DIR"
          EOF

      - name: Stop PM2 Process
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          set -e; echo "Stopping PM2 process..."
          pm2 stop ${{ secrets.APP_NAME }} 2>/dev/null || echo "No existing process to stop"
          pm2 delete ${{ secrets.APP_NAME }} 2>/dev/null || echo "No existing process to delete"
          EOF

      - name: Clone Repository
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          set -e; echo "Cloning repository..."
          rm -rf "$TEMP_DIR"
          git clone --depth 1 https://github.com/we-are-proxy/InterstellarProxy "$TEMP_DIR"
          cd "$TEMP_DIR"
          git checkout
          EOF

      - name: Backup Old Deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          set -e; echo "Backing up old deployment..."
          if [ -d "$DEPLOY_DIR/current" ]; then
            rm -rf "$DEPLOY_DIR/backup"
            mv "$DEPLOY_DIR/current" "$DEPLOY_DIR/backup"
          fi
          EOF

      - name: Move New Deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          set -e; echo "Moving new deployment..."
          mv "$TEMP_DIR" "$DEPLOY_DIR/current"
          cd "$DEPLOY_DIR/current"
          EOF

      - name: Install Dependencies
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
                ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
                set -e
                echo "Installing dependencies..."
                if [ -f "package.json" ]; then
                  npm install --omit=dev
                else
                  echo "Error: package.json not found!"
                  exit 1
                fi

      - name: Start Application with PM2
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
          set -e
          echo "Checking if ecosystem.config.cjs exists..."
          if [ ! -f "ecosystem.config.cjs" ]; then
            echo "Error: ecosystem.config.cjs not found!"
            ls
            exit 1
          fi
          
          echo "Starting application with PM2..."
          pm2 start ecosystem.config.cjs
          pm2 save
          
          echo "✅ Deployment completed successfully!"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

  Nginx:
    runs-on: ubuntu-latest
    needs: Deploy

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Configure Nginx
        run: |
          echo "Configuring Nginx..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "Creating Nginx configuration..."
            NGINX_CONF="/etc/nginx/sites-available/${{ secrets.APP_NAME }}"

            sudo unlink /etc/nginx/sites-available/proxy
            sudo unlink /etc/nginx/sites-enabled/proxy

            sudo ln -s ./nginx.conf /etc/nginx/sites-available/proxy
            sudo ln -s /etc/nginx/sites-available/ /etc/nginx/sites-enabled/
          EOF
      - name: Enable Nginx
        run: |
          echo "Enabling Nginx..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "Testing Nginx configuration..."
            sudo nginx -t
            
            echo "Reloading Nginx..."
            sudo systemctl reload nginx
            
            echo "✅ Nginx configured successfully!"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key