name: Deploy to Web Server

on:
    pull_request:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        container:
            image: node:22
        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
                run: npm ci

            - name: Build static site
                run: npm run build

            - name: Prepare SSH
                run: |
                    mkdir -p ~/.ssh
                    echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                    chmod 600 ~/.ssh/id_rsa
                    ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

            - name: Upload build artifacts
                run: scp -r ./build ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/root/proxy

            - name: Build and restart nginx container
                run: |
                    ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<'EOF'
                    set -e
                    cd /root/proxy
                    docker build -t proxy-static .
                    docker rm -f proxy-static || true
                    docker run -d --name proxy-static -p 80:80 proxy-static
                    EOF
            